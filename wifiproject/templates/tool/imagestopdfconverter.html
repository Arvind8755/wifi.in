{% extends "base.html" %}
{% load static %}

{% block seo %}
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Images → PDF Converter — WifiResult Tool</title>
<meta name="description" content="Convert single or multiple images to a single PDF. Choose page size, orientation, margins, image fit, and output quality." />
{% endblock seo %}

{% block style %}
<style>
 :root{
  --bg:#f7fafc; --card:#fff; --accent:#0ea5e9; --muted:#6b7280; --radius:14px;
 }
 *{box-sizing:border-box}
 body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:linear-gradient(180deg,#fbfdff,#f0f9ff); color:#0f172a}
 .wrap{max-width:980px;margin:28px auto;padding:20px}
 h1{margin:0 0 12px;font-size:20px}
 .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 30px rgba(2,6,23,.06)}
 .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
 @media(max-width:900px){.grid{grid-template-columns:1fr}}
 label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
 input[type=file]{display:block}
 .controls{display:grid;gap:10px}
 .row{display:flex;gap:8px;align-items:center}
 select, input[type=text], input[type=number]{padding:10px;border-radius:10px;border:1px solid #e6eef7;width:100%}
 button{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
 .btn-ghost{background:#fff;border:1px solid #e6eef7;color:#0f172a}
 .preview{display:flex;flex-direction:column;gap:10px;align-items:center}
 .thumbs{display:flex;gap:8px;flex-wrap:wrap}
 .thumb{width:70px;height:70px;border-radius:6px;border:1px solid #e6eef7;overflow:hidden;display:flex;align-items:center;justify-content:center}
 .thumb img{max-width:100%;max-height:100%}
 .meta{font-size:13px;color:var(--muted)}
 .small{font-size:12px;color:var(--muted)}
 .progress{height:8px;background:#e6eef7;border-radius:8px;overflow:hidden}
 .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#06b6d4);width:0%}
 .help{font-size:12px;color:var(--muted)}
 .toggle{display:inline-flex;align-items:center;gap:8px}
 .iframe-preview{width:100%;height:420px;border:1px solid #e6eef7;border-radius:8px}
</style>
{% endblock style %}

{% block content %}
<div class="wrap">
  <h1>Images → PDF Converter</h1>
  <div class="card grid">
    <div>
      <div class="card" style="padding:12px">
        <label>Upload Images</label>
        <input id="fileInput" type="file" accept="image/*" multiple />
        <div style="margin-top:8px" class="small">Supported: PNG, JPEG, WEBP, HEIC (if browser supports). Select multiple files to combine into one PDF.</div>

        <hr style="margin:12px 0" />

        <div class="controls">
          <div class="row">
            <div style="flex:1">
              <label>Page Size</label>
              <select id="pageSize">
                <option value="a4">A4 (210 × 297 mm)</option>
                <option value="letter">Letter (8.5 × 11 in)</option>
                <option value="a5">A5 (148 × 210 mm)</option>
                <option value="custom">Custom (px)</option>
              </select>
            </div>
            <div style="width:140px">
              <label>Orientation</label>
              <select id="orientation">
                <option value="portrait">Portrait</option>
                <option value="landscape">Landscape</option>
              </select>
            </div>
          </div>

          <div id="customSizeRow" class="row" style="display:none">
            <div style="flex:1">
              <label>Custom Width (px)</label>
              <input id="customW" type="number" min="100" placeholder="e.g., 1240" />
            </div>
            <div style="width:140px">
              <label>Custom Height (px)</label>
              <input id="customH" type="number" min="100" placeholder="e.g., 1754" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Margins (mm)</label>
              <input id="margin" type="number" min="0" value="10" />
            </div>
            <div style="width:160px">
              <label>Image Fit</label>
              <select id="imgFit">
                <option value="contain">Contain (fit within page, preserve aspect)</option>
                <option value="cover">Cover (fill page, may crop)</option>
                <option value="stretch">Stretch (fill page, ignore aspect)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Output Image Quality (0.1 - 1) — affects JPG/WebP used to embed images</label>
              <input id="imgQuality" type="number" step="0.05" min="0.1" max="1" value="0.92" />
            </div>
            <div style="width:160px">
              <label>Images per page</label>
              <select id="perPage">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4">4</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Filename</label>
              <input id="outName" type="text" placeholder="images-to-pdf" />
            </div>
            <div style="width:160px">
              <label class="toggle"><input id="openPreview" type="checkbox" checked /> Open preview after generate</label>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="generateBtn">Generate PDF</button>
            <button id="downloadBtn" class="btn-ghost">Download Last PDF</button>
            <button id="resetBtn" class="btn-ghost">Reset</button>
          </div>

          <div style="margin-top:8px">
            <div class="progress" aria-hidden>
              <i id="progressBar"></i>
            </div>
          </div>

          <div style="margin-top:8px" class="help">Tip: For best results, upload images with sufficient resolution for your selected page size. If PDF is large, try lowering Image Quality.</div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <label>How to Use</label>
        <div class="small" style="margin-top:8px;line-height:1.5">
          <ul>
            <li>Upload one or more images. Order will follow your file selection order.</li>
            <li>Choose Page Size, Orientation, Margins and Image Fit.</li>
            <li>Set Images per page (1, 2, or 4). Each page will place that many images in a grid.</li>
            <li>Click "Generate PDF" to create the PDF. Use "Download Last PDF" to save again.</li>
            <li>Preview opens an embedded viewer (if enabled).</li>
          </ul>
        </div>
      </div>
    </div>

    <aside>
      <div class="card preview">
        <div style="width:100%">
          <label>Preview & Thumbnails</label>
          <div style="border:1px dashed #e6eef7;padding:8px;border-radius:8px;min-height:180px;display:flex;flex-direction:column;gap:8px">
            <div class="thumbs" id="thumbs"></div>
            <div id="placeholder" class="meta">No images loaded</div>
          </div>
        </div>

        <div style="width:100%;display:flex;flex-direction:column;gap:8px;margin-top:10px">
          <div class="meta">Files: <span id="fileCount">0</span> • Total size: <span id="totalSize">—</span></div>
          <div class="meta">Last PDF: <span id="lastPdfSize">—</span></div>
          <div id="pdfPreviewWrap" style="width:100%;display:none;margin-top:8px">
            <label>PDF Preview</label>
            <iframe id="pdfPreview" class="iframe-preview"></iframe>
            <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
              <button id="openInNew" class="btn-ghost">Open in new tab</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
            <button id="downloadPreviewBtn" class="btn-ghost">Download Preview</button>
          </div>
        </div>
      </div>
    </aside>

  </div>

  <div style="margin-top:12px" class="small">© <span id="year"></span> wifiresult — Images to PDF</div>
</div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(function(){
  const { jsPDF } = window.jspdf;

  const fileInput = document.getElementById('fileInput');
  const thumbs = document.getElementById('thumbs');
  const placeholder = document.getElementById('placeholder');
  const fileCount = document.getElementById('fileCount');
  const totalSizeEl = document.getElementById('totalSize');
  const lastPdfSize = document.getElementById('lastPdfSize');
  const pdfPreviewWrap = document.getElementById('pdfPreviewWrap');
  const pdfPreview = document.getElementById('pdfPreview');
  const openInNew = document.getElementById('openInNew');
  const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');

  const pageSize = document.getElementById('pageSize');
  const orientation = document.getElementById('orientation');
  const customSizeRow = document.getElementById('customSizeRow');
  const customW = document.getElementById('customW');
  const customH = document.getElementById('customH');
  const marginEl = document.getElementById('margin');
  const imgFit = document.getElementById('imgFit');
  const imgQuality = document.getElementById('imgQuality');
  const perPage = document.getElementById('perPage');
  const outName = document.getElementById('outName');
  const generateBtn = document.getElementById('generateBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const progressBar = document.getElementById('progressBar');
  const openPreview = document.getElementById('openPreview');

  document.getElementById('year').textContent = new Date().getFullYear();

  let files = [];
  let imgElements = []; // {file, img, w,h}
  let lastPdfBlob = null;

  function setProgress(p){ progressBar.style.width = (p*100)+'%'; }

  pageSize.addEventListener('change', ()=>{
    customSizeRow.style.display = pageSize.value==='custom' ? 'flex' : 'none';
  });

  fileInput.addEventListener('change', async (e)=>{
    const fList = Array.from(e.target.files || []);
    if(!fList.length) return resetAll();
    files = fList;
    await loadThumbnails();
  });

  function formatBytes(n){ if(n==null) return '—'; if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(2)+' MB'; }

  async function loadThumbnails(){
    thumbs.innerHTML = ''; imgElements = [];
    let total=0;
    setProgress(0.05);
    for(let i=0;i<files.length;i++){
      const f = files[i]; total += f.size;
      const url = URL.createObjectURL(f);
      const img = new Image();
      await new Promise((res,rej)=>{
        img.onload = ()=>{ res(); };
        img.onerror = ()=>{ res(); };
        img.src = url;
      });
      const div = document.createElement('div'); div.className='thumb';
      const imgEl = document.createElement('img'); imgEl.src = img.src;
      div.appendChild(imgEl); thumbs.appendChild(div);
      imgElements.push({file:files[i], img:img, w:img.width, h:img.height, url:img.src});
      setProgress(0.05 + (i+1)/files.length*0.7);
    }
    fileCount.textContent = files.length;
    totalSizeEl.textContent = formatBytes(total);
    placeholder.style.display = 'none';
    setTimeout(()=>setProgress(0),400);
  }

  function getPageDimensions(){
    // return {wPts, hPts} in points (1pt = 1/72 in). jsPDF default units are "pt" unless specified.
    // We'll use 'pt' unit. Convert mm/in to pt.
    const mmToPt = mm => mm * 2.83464567; // 1 mm = 2.83464567 pt
    if(pageSize.value === 'a4'){
      const w = orientation.value==='portrait' ? mmToPt(210) : mmToPt(297);
      const h = orientation.value==='portrait' ? mmToPt(297) : mmToPt(210);
      return {w,h};
    }
    if(pageSize.value === 'a5'){
      const w = orientation.value==='portrait' ? mmToPt(148) : mmToPt(210);
      const h = orientation.value==='portrait' ? mmToPt(210) : mmToPt(148);
      return {w,h};
    }
    if(pageSize.value === 'letter'){
      const inToPt = inch => inch * 72;
      const w = orientation.value==='portrait' ? inToPt(8.5) : inToPt(11);
      const h = orientation.value==='portrait' ? inToPt(11) : inToPt(8.5);
      return {w,h};
    }
    // custom px assumed as pixels: we'll treat px at 96dpi -> convert px to pt: pt = px * (72/96) = px * 0.75
    if(pageSize.value === 'custom'){
      const cw = parseInt(customW.value,10) || 1240;
      const ch = parseInt(customH.value,10) || 1754;
      return {w: cw * 0.75, h: ch * 0.75};
    }
    return {w:mmToPt(210), h:mmToPt(297)};
  }

  function placeImageOnCanvas(imgObj, targetW, targetH, fit){
    // Draw image onto intermediate canvas sized targetW x targetH (px). Return dataURL (jpeg/webp) according to quality.
    const canvas = document.createElement('canvas');
    // We'll use targetW,targetH in px at 96dpi approximation. Convert points to px: px = pt * (96/72) = pt * 1.3333
    const ptToPx = v => Math.round(v * 1.3333333);
    const wPx = ptToPx(targetW);
    const hPx = ptToPx(targetH);
    canvas.width = Math.max(1, wPx);
    canvas.height = Math.max(1, hPx);
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const sw = imgObj.w, sh = imgObj.h;
    if(fit === 'stretch'){
      ctx.drawImage(imgObj.img, 0,0,sw,sh, 0,0,canvas.width,canvas.height);
    } else if(fit === 'contain'){
      // fit inside
      const srcRatio = sw/sh; const tgtRatio = canvas.width/canvas.height;
      let dw = canvas.width, dh = Math.round(dw / srcRatio);
      if(dh > canvas.height){ dh = canvas.height; dw = Math.round(dh * srcRatio); }
      const dx = Math.round((canvas.width - dw)/2), dy = Math.round((canvas.height - dh)/2);
      ctx.drawImage(imgObj.img, 0,0,sw,sh, dx,dy,dw,dh);
    } else if(fit === 'cover'){
      // fill and crop
      const srcRatio = sw/sh; const tgtRatio = canvas.width/canvas.height;
      if(srcRatio > tgtRatio){
        // source wider -> crop sides
        const shCrop = sh; const swCrop = Math.round(shCrop * tgtRatio);
        const sx = Math.round((sw - swCrop)/2);
        ctx.drawImage(imgObj.img, sx,0,swCrop,shCrop, 0,0,canvas.width,canvas.height);
      } else {
        const swCrop = sw; const shCrop = Math.round(swCrop / tgtRatio);
        const sy = Math.round((sh - shCrop)/2);
        ctx.drawImage(imgObj.img, 0,sy,swCrop,shCrop, 0,0,canvas.width,canvas.height);
      }
    }
    // quality and output format: we'll use 'image/jpeg' for smaller size unless source has transparency and user didn't need white background (we always used white)
    const q = parseFloat(imgQuality.value) || 0.92;
    return canvas.toDataURL('image/jpeg', q);
  }

  async function generatePDF(){
    if(!imgElements.length){ alert('Please upload images first'); return; }
    setProgress(0.02);
    const per = parseInt(perPage.value,10) || 1;
    const fit = imgFit.value;
    const marginMm = parseFloat(marginEl.value) || 10;
    const marginPt = marginMm * 2.83464567;
    const {w:pageW, h:pageH} = getPageDimensions();
    const doc = new jsPDF({unit:'pt', format:[pageW, pageH], orientation: orientation.value});
    const pages = [];
    // We'll place up to `per` images in one page in a grid (1 => full, 2 => two rows, 4 => 2x2)
    const grid = per === 1 ? [1,1] : per === 2 ? [2,1] : [2,2];

    // Prepare a sequence of image placements (group into pages)
    let idx = 0;
    const totalImgs = imgElements.length;
    const totalPages = Math.ceil(totalImgs / per);
    for(let p=0;p<totalPages;p++){
      // create page canvas dims for each slot
      const slots = [];
      const cols = grid[1];
      const rows = grid[0];
      const innerW = pageW - marginPt*2;
      const innerH = pageH - marginPt*2;
      const slotW = innerW / cols;
      const slotH = innerH / rows;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          slots.push({
            x: marginPt + c*slotW,
            y: marginPt + r*slotH,
            w: slotW,
            h: slotH
          });
        }
      }
      // for each slot, if there's an image, render and add to PDF
      for(let s=0;s<per;s++){
        if(idx >= totalImgs) break;
        const imgObj = imgElements[idx];
        setProgress(0.05 + (idx/totalImgs)*0.85);
        // create dataURL scaled appropriately
        const slot = slots[s];
        // produce a data URL using a canvas sized slot.w x slot.h (in points) for good quality
        const dataUrl = placeImageOnCanvas(imgObj, slot.w, slot.h, fit);
        // add to PDF
        // addImage expects image format and coordinates in points; use slot.x, slot.y, slot.w, slot.h
        doc.addImage(dataUrl, 'JPEG', slot.x, slot.y, slot.w, slot.h);
        idx++;
      }
      if(p < totalPages - 1) doc.addPage([pageW, pageH], orientation.value);
    }

    setProgress(1);
    const pdfBlob = doc.output('blob');
    lastPdfBlob = pdfBlob;
    lastPdfSize.textContent = formatBytes(pdfBlob.size);
    if(openPreview.checked){
      const url = URL.createObjectURL(pdfBlob);
      pdfPreview.src = url;
      pdfPreviewWrap.style.display = 'block';
      openInNew.onclick = ()=> window.open(url, '_blank');
      downloadPreviewBtn.onclick = ()=> {
        const filename = (outName.value || 'images-to-pdf') + '.pdf';
        const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      };
    }
    // auto trigger download if user clicked generate and didn't want preview? We will NOT auto-download — provide Download Last PDF button
    setTimeout(()=>setProgress(0),600);
    alert('PDF generated. Use "Download Last PDF" to save it.');
  }

  generateBtn.addEventListener('click', async ()=>{
    try{ await generatePDF(); } catch(e){ console.error(e); alert('Failed to generate PDF: '+ (e.message || e)); setProgress(0); }
  });

  downloadBtn.addEventListener('click', ()=>{
    if(!lastPdfBlob){ alert('No PDF available. Click Generate PDF first.'); return; }
    const url = URL.createObjectURL(lastPdfBlob);
    const filename = (outName.value || 'images-to-pdf') + '.pdf';
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  });

  downloadPreviewBtn.addEventListener('click', ()=>{
    if(!lastPdfBlob){ alert('No PDF available. Click Generate PDF first.'); return; }
    const url = URL.createObjectURL(lastPdfBlob);
    const a = document.createElement('a'); a.href = url; a.download = (outName.value || 'images-to-pdf') + '.pdf'; a.click();
  });

  resetBtn.addEventListener('click', resetAll);

  function resetAll(){
    fileInput.value = ''; thumbs.innerHTML = ''; placeholder.style.display='block';
    fileCount.textContent = 0; totalSizeEl.textContent = '—'; lastPdfSize.textContent = '—';
    pdfPreviewWrap.style.display='none'; pdfPreview.src=''; openInNew.onclick = null;
    files = []; imgElements = []; lastPdfBlob = null; setProgress(0);
  }

  // cleanup object URLs on unload
  window.addEventListener('unload', ()=>{ try{ pdfPreview.src=''; }catch(e){} });
})();
</script>
{% endblock content %}  

















